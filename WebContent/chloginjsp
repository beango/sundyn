<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%
    String path = request.getContextPath();
    String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path;
    String qloginmsg = request.getParameter("msg")==null?"":com.sundyn.utils.ReqUtils.format(request.getAttribute("msg").toString());
%>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>欢迎登录后台管理系统</title>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="lib/layui/css/layui.css"  media="all">
    <script type="text/javascript" src="js/jquery.js"></script>
    <script language="JavaScript" src="js/dojo.js"></script>
    <script type="text/javascript" src="lib/layer/layer.js"></script>
    <script language="JavaScript" src="js/md5.min.js"></script>
    <script language="JavaScript" src="js/my_zh.js"></script>
    <script>
        // base64加密开始
        var keyStr = "ABCDEFGHIJKLMNOP" + "QRSTUVWXYZabcdef" + "ghijklmnopqrstuv"
            + "wxyz0123456789+/" + "=";

        function encode64(input) {

            var output = "";
            var chr1, chr2, chr3 = "";
            var enc1, enc2, enc3, enc4 = "";
            var i = 0;
            do {
                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);
                enc1 = chr1 >> 2;
                enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                enc4 = chr3 & 63;
                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                } else if (isNaN(chr3)) {
                    enc4 = 64;
                }
                output = output + keyStr.charAt(enc1) + keyStr.charAt(enc2)
                    + keyStr.charAt(enc3) + keyStr.charAt(enc4);
                chr1 = chr2 = chr3 = "";
                enc1 = enc2 = enc3 = enc4 = "";
            } while (i < input.length);

            return output;
        }
    </script>
    <script language="javascript">
        $(function () {
            var loginmsg = '${loginmsg}';
            if(loginmsg=='')
                loginmsg = '${msg}';
            var qloginmsg = '<%= qloginmsg%>';
            if (qloginmsg!='')
                loginmsg = qloginmsg;
            if(self!=top){
                top.document.location.href="<%= basePath %>/login.jsp?msg=" + loginmsg;
                return;
            }
            if (loginmsg != '')
                lalert(loginmsg)
            $('.loginbox').css({'position': 'absolute', 'left': ($(window).width() - 692) / 2});
            $(window).resize(function () {
                $('.loginbox').css({'position': 'absolute', 'left': ($(window).width() - 692) / 2});
            });

            var root = document.getElementById('loginbody');
            document.body.addEventListener('keyup', function (e) {
                if (e.keyCode == '13') {
                    doclick();
                }
            });
        });

        function _$(id){return document.getElementById(id);}

        function doclick(){
            var s = "";
            if(!_$('name').value){s += "账号不能为空!<br />";}
            if(!_$('password1').value){s += "密码不能为空!";}
            if(s != ""){
                layer.msg(s, {icon: 2});
                return;
            }
            _$('password').value = _$('password1').value;
            lsubmit("managerLogin.action", {
                name: encode64(_$('name').value),
                password:md5(_$('password').value)
            }, function(resp){
                if (resp.succ){
                    succ(resp.msg, function () {
                    });
                    loginRedirec();
                }
                else
                {
                    if (resp.msg == "信息被变更,请重新修改密码!"){
                        lalert2(resp.msg, redir2Changepwd);
                    }
                    else
                        error(resp.msg);
                }
            });
        }

        function loginRedirec(){
            if(self!=top){
                document.location.href="<%= basePath %>/queryIndex.action";
            }else{
                document.location.href="<%= basePath %>/default.jsp";
            }
        }

        function redir2Changepwd(){
            document.location.href="<%= basePath %>/managerChangePsw.action?type=1&name=" + _$('name').value;
        }
    </script>

</head>

<body style="background-color:#1c77ac; background-image:url(images/managementLogin3.png); background-repeat:no-repeat; background-position:center top; overflow:hidden;">

<div id="mainBody">
    <div id="cloud1" class="cloud"></div>
    <div id="cloud2" class="cloud"></div>
</div>

<%--<div class="logintop">
    <span>欢迎登录后台管理界面平台</span>
</div>--%>

<div class="loginbody" id="loginbody">
    <span class="systemlogo"></span>
    <div class="loginbox">
        <form method="post" id="v" action="managerLogin.action" class="form-condensed">
        <ul>
            <li><label style="font-size:13pt;color:#fff;font-weight:bold;">账号：</label><input  name="managerVo.name" id="name" type="text" class="loginuser" value="" onclick="JavaScript:this.value=''"/></li>
            <li><label style="font-size:13pt;color:#fff;font-weight:bold;">密码：</label><input name="password1" id="password1" type="password" class="loginpwd" value="" onclick="JavaScript:this.value=''"/></li>
            <li style="padding-left:75px;"><input name="" type="button" class="loginbtn" value="登录" onclick="doclick()"/>
                <%--<label style="color:#fff;"><input type="checkbox" value="on" id="savename" style="color:#fff;"/>记住密码</label>--%>
                <input type="hidden" title="密码" name="managerVo.password" id="password" value="" />
                <label class="msg" style="height:20px;color:red;">${msg}</label>
            </li>
            <li></li>
        </ul>
        </form>
    </div>
</div>
<div class="loginbm"></div>
</body>
</html>
